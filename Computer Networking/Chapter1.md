# 什么是网络

**互联网、网际**：很多网络，通过网络互联设备连在一起（网络的网络）

* **网络**：蜘蛛网、渔网、神经网络，包括节点和链路（图结构，与形状无关）
* **计算机网络**：联网的计算机构成的系统。
  * **节点**：
    * 包括主机节点（笔记本电脑、平板、手机、联网的冰箱、服务器等，源主机目标主机）
    * 和数据交换节点（负载均衡设备、中继器、路由器、交换机等，既不是源也不是目标，起转发作用）
  * **链路**：连接主机和交换节点。连接交换节点和交换节点。
    * 分为接入网链路：主机接入到最近的交换机的链路
    * 和主干链路：交换节点和交换节点之间的链路
  * **协议**：对等层实体，在通信过程中应该遵守的规则的集合。包括语法语义和时序

* **互联网**：
  * TCP/IP协议为主的一族协议。由这些协议支撑起的那个网络就是互联网。Internet
  * 如果与别人不连，但仍然也是依照TCP/IP协议工作，就是intranet，企业网、内联网
  * **从构成的角度**：是网络的网络
    * 拥有数以亿计的、互联的计算设备。
      * 包括主机：端系统，即host或end system（用方框表示）
      * 能够运行网络应用程序
    * 通信链路
      * 包括光纤、同轴电缆、无线电等
      * 主要指标：传输速率（带宽bps）
  * 协议：互联网中所有行为都通过协议规范（显式的法律、隐式的校规）。包括语法语义时序动作。
  * 标准：以互联网工程任务组IETF发布的RFC标准。
  * **从服务的角度**：
    * 使用通信基础设施进行通信的分布式应用进程。
      * **分布式应用**：网络存在的理由
      * **通信基础设施**：为分布式应用，提供远程的通信服务。包括应用层之下所有的应用实体，以及所有网络部分。
    * 通信基础设施为apps提供编程接口（通信服务）

------------

>  互联网，**按照组成类型**，分成一个个子系统（包括**网络边缘**、**网络核心**和**接入网与物理媒体**）
>
> * 边缘通过接入，连接核心
> * 核心把所有边缘连在一起
> * 任意两个端系统之间，可通信
> * 接入形式：可以是移动接入，可以有线接入

## 网络边缘：边缘系统上存在的网络应用，是网络存在的理由

**应用进程之间通信的两种模式**

1. **客户端服务器模式**

​		主机进一步分为客户端和服务器。客户端请求，服务端响应。资源在服务器。客户端依赖服务器。服务器要先运行起来，等待客户端请求。

​		这种模式可扩展性较差。可能会导致宕机。可靠性也不高。

2. **Peer-Peer模式（对等模式，P2P模式）**

​		每个结点，既是客户端又是服务器，是分布式的。在部分的会话中，是客户端，接受文件；但在另一部分会话中，是服务器，发送文件。

​		你向其他迅雷客户端，请求文件片段。然后你拥有了一定的文件片段，又可以向其他用户提供文件片段。

**通信方式：采用网络基础设施提供的面向连接的通信服务**

1. **TCP服务**

>  可靠的，保序的。面向连接：通信状态在端系统中维护，网络不维护。有连接：通信状态端系统和网络都维护。
>
> 流量控制。协调发送接收速度。受到发送端接收端缓冲池大小。
>
> 拥塞控制。受到网络传输速度影响	
>
> HTTP，FTP，SMTP等

2. **UDP服务**：用户数据报协议

> 无连接的，不可靠，没有流量控制，没有拥塞控制。
>
> 常用于：流媒体、远程会议、网络电话

​		

## 网络核心：数据交换

是路由器的网状网络。**基本问题**：数据如何通过网络进行传输

* 电路交换（线路交换）

  * 为每个呼叫预留一条专有线路。如电话网

  * 主机间通信，首先通过信令系统，在网络核心中，为两者的通信分配一条独享的线路。

    * 带宽很大，通过一系列的技术，可以进行分片复用（频分FDM、时分TDM、波分WDM、码分CDM）。

      > 频分：连续性得到部分带宽。以频段分割
      >
      > 时分：间歇性获得全部带宽。以时间周期性分割（时分，将每个周期都均分为时槽）

  * 资源独享，可以保证性能。如果没有数据发送，资源就会被浪费。

  * 建立时间长。且计算机间通信具有突发性，如果建立独占连接，那么浪费多。

  * 可靠性不高。如果中心节点损毁，那么通信中断，影响范围大。

* 分组交换：以分组为单位，存储转发

  * 节点之间通信链路不再细分为pieces

  * 主机主机之间通信数据分成packet

  * 以packet为单位，在每个交换节点中存储转发（先把分组存下来，然后再转发）

    > 为什么要存储转发？可以按需使用，如果不存储，就变成了独享。

  * 属于**统计多路复用**。分组没有固定的模式，是随机划分时间片的，是特殊的时分。

  * 延迟：比线路交换大。

    * 节点中要消耗存储时间、排队时间。但作为交换，**得到了共享性**。但利用率高，避免浪费。
    * **在一个速率为R bps的链路（一跳），一个长度为L bits的分组的存储转发延时：L/R s**
    * 排队延迟和丢失：如果路由器**缓存满**了，那么新来的分组，会**被丢弃**。
  
  * 过度使用会导致拥塞。

网路核心的关键功能：**路由**和**转发**

* 路由：决定分组采用的，从源到目标的路径。通过路由算法算出
* 转发：将分组从输入链路转发到输出链路

存储转发的两个方式：**数据报**和**虚电路**

* 数据报：无需建立连接，有数据直接发送，每一个分组都独立路由（路径不一样，可能失序）路由器根据分组目标地址进行转发
* 虚电路：要建立虚电路表。靠信令建立。查表转发。

# 接入网和物理媒体

**边缘系统通过接入网接入网络核心**：接入网的带宽一般是共享的

1. **住宅接入**：modem，调制解调器。

> **现行的解决方法是，专线铺到每家每户。但成本高。**
>
> 90年代考虑利用现有的网络资源，让每家每户接入进来。（利用原来的电话线网络，通过调制解调器）
>
> 由于电话线穿的是语音，所以带宽只有4 kHz。所以需要借助一些额外的设备。
>
> 装一个**猫（起到调制解调的作用）**，通过调频或调相位，连接电话网和互联网。在音频载波上，加载01的数据，就好像在载波上冲浪一样。
>
> 但这样，就与打电话形成了互斥。打电话时，不能上网。同样的，上网时，没办法打电话

2. **接入网**：digital subscriber line，DSL（电信公司提供的上网网络）

> 能够保证4 kHz的带宽，高于4 kHz的部分，非对称地划分为上行带宽（小些）和下行带宽（大些）两个部分，**称为ADSL**，并且同样采用调制解调的方法。
>
> 通过ADSL猫来上网。这样可以同时保证打电话和上网。

3. **接入网**：线缆网络（有线电视公司提供的上网网络）

> 有线电视信号线缆的双向改造。（原来是单向，仅有下行带宽，电视公司用于广播电视信号）
>
> 现在通过双向改造，不同频段传输不同信道的通信数据。有些带宽是上行的，有些带宽是下行的。**这些带宽是共享的**。
>
> 往上层是光纤，往下是铜轴电缆。带宽划分非对称，最高30 Mbps的下行速率，最低2 Mbps的上行传输速率。

4. **住宅接入：电缆模式**

> 很多都采用了互联网电视。有限电视公司的业务在萎缩。

5. **无线接入网路**

> WLANs，广域无线接入，无线局域网WiFi

6. **企业接入网**：Ethernet

> 被企业、大学等机构采用。现在端系统常直接接到以太网络交换机上。

# 物理媒体：第0层

发送和接收两个节点。在两个节点对之间传送比特。

物理媒体：可以是**光纤、铜轴电缆、以太网网线或者开放的空间（传送电磁波）**等

* 导引型媒体
  * 电磁波信号沿着固体媒体被导引（同轴电缆、光纤、双绞线）
    * 同轴电缆：连根同心的铜导线。是双向的。分为宽带电缆（多信道）和基带（窄带）电缆（单信道）。
    * 双绞线：两根绝缘铜线绞合在一起。常用5类、6类两种
    * 光缆和光纤：不会受到电磁波干扰，涉及全反射理论。有单模光纤和多模光纤两类
* 非导引型媒体
  * 开放空间的**无线链路**，双向。受到传播环境影响
    * 地面微波
    * LAN（例如：WiFi）
    * wide-area广域无线（例如：蜂窝）
    * 卫星

# Internet结构和ISP

互联网的结构：网络的网络

* ISP，Internet Service Provider互联网服务提供商（提供入网）
* ICP，Internet Content Provider互联网内容服务商（提供业务）
* IXP，Internet Exchange Point互联网交换中心
* 端系统通过接入ISPs（住宅、公司和学校的ISPs）连接到互联网。
* 接入ISPs相应的，必须是互联的。所以任何两个端系统，才可以互相发送数据
* 经济政治策略影响互联网演化

**问题：如何将ISP互联？演化过程：**

* 全连接，两个ISP直接相连，可扩展性差，不可扩展。复杂度为$O(n)$
* 每个ISPs都接入到Global ISPs中。以经济合约约束双方的行为。
* Global ISPs之间的竞争与合作

**通常ICP如Google会在全球各地建造DC（Data Center），然后自拉或者租用干线光缆，使得DC互联**，原因有：

* ISP的服务费用高
* ISP不能提供及时有效的服务
* 在大网里面部署专网，可以为用户提供较好的服务，并减少成本。
* 通常会在凉的地方（降温），高山之中（安全），地质稳定（不地震）

**网络结构：**

* Tier1 ISP（中心，第一层ISP，全球、全国范围，点少但带宽大，通过peer连接或者IXP连接）
* Tier2 ISP：Rigional ISP，第二层ISP，更小一些的，区域性的ISP，可与一个或多个第一层ISP连接，也可以与其他第二层ISP连接
* 还有Tier3 ISP等
* local ISP：access net，access ISP，终端通过local ISP接入。

# 分组延时、丢失和吞吐量

**分组的丢失和延时是怎么发生的**：路由器缓冲区中存在一个分组队列

> 如果分组达到路由器的速率大于链路输出的能力，那么对应地，分组进入分组队列等待，造成延迟。
>
> **四种延时**每一跳都会产生这四种延时：
>
> * **结点处理延时**（校验错误，提取目标ip查路由表，进行其他处理，这个时间是比较固定的，可以预估，一般是微秒）
> * **排队延时**（取决于网络使用情况，是随机的）
> * **传输延时**（R是链路带宽，L是分组长度，将分组发送到链路上的时间是L/R，是固定的，可以预估）
> * **传播延时**（与距离以及传播速度有关，距离如果超近，可忽略）
>
> 但是队列是有限的。如果队列已经满了，还来了新的分组，那么新分组就会被丢弃。这就是丢失。
>
> **丢失了怎么办？**
>
> * 如果链路本身可靠，则由上一个结点重传
> * 如果链路不可靠，则由源主机重传
> * 如果是UDP，那么根本不重传
>
> 为什么不把队列调大一点，避免丢失？调大虽然不丢，如果有几千个分组，排队一两天到队头被转发，用户早就不耐烦了
>
> **信道容量**：局域网容量小，广域网容量大。
>
> **流量强度**：$$I=\frac{La}{R}$$，其中L是每个分组的长度，a是单位时间内通过这条链路转发的分组数，R是链路带宽。
>
> * 流量强度越接近极限值1，排队延时越大。超过1，排队延时无穷。流量强度越接近与0或较小的时候，排队延时就很小

同样的网络资源，分组交换允许更多的用户。

可以在cmd窗口运行traceroute命令，测量往返延迟，运用了**ICMP协议：互联网控制报文协议**。分为IP头、TTL以及IP数据。

**吞吐量**：在源端和目标端之间的传输速率（数据量/时间单位）

* 瞬间吞吐量：在一个点的速率
* 平均吞吐量：在一个长时间的平均值
  * 端到端的平均吞吐取决于瓶颈链路的大小。
  * 实际情况，每一跳的链路，实际上都被很多用户共用，平分带宽。所以平分后的带宽才是瓶颈带宽

# 协议层次和服务模型

**引例**：异地哲学家的交流，航线的功能和层次。

**分层的思想**：把网络非常复杂的功能分解成功能明确的层次。每一层实现一个，或者一组功能。

* 本层的一些功能可以被上层调用。上层可以调用的本层功能的子集，就是服务。
* 协议是水平的一个关系，本层的协议实体相互交互实行本层**协议动作**，形成新的服务特性
* 协议的实现：通过层间接口访问下层服务才能实现，通过下层服务交换PDU，实现本层的功能
* 协议的目的：为上层提供更好的服务

**服务和服务访问点**

> **服务提供者**，通过层间界面具体的**SAP服务访问点**，向**服务用户**提供服务。
>
> **服务用户**通过**原语（提供服务的形式）**使用**服务提供者**的服务，**服务提供者**通过原语向**服务用户**提供服务
>
> **服务访问点**：上层访问下层所提供服务的点

**服务的形式**：

* 面向连接的服务，如TCP（需要握手，建立连接）
* 无连接的服务，如UDP（不需要建立连接）
* 服务是垂直的关系，层间的关系。 

**本层协议实现的时候，需要借助下层的服务。实现本层协议的目的，就是为了为上层提供更好的服务。**

**数据单元DU**

* 服务数据单元SDU：上层要求传的东西。
* SDU穿过层间接口时，增加控制信息ICR，变成了IDU
* 穿过层间接口后，这个ICR就没用了，SDU拿到之后，然后增加本层的header，形成本层的PDU。

> 如果SDU很大，那么可能会分成好几部分，分别加上header，然后形成多个PDU
>
> 也有可能SDU很小，那么我们可能会把好多个SDU拼在一起，然后加上header，形成一个PDU
>
> header一部分是从ICR转过来的，一部分是协议新加的。

**PDU的不同称呼**

应用层：应用报文message

传输层：报文段（段）segment

网络层：分组（无连接：IP数据报）packet

链路层：帧frame

物理层：传的是比特bit

**分层处理的好处**

概念化，结构清晰，分层参考模型。

结构化，分而治之。层间接口不变，那么层内具体实现无关，改变某一层的实现也不影响系统其他部分。

模块化，便于维护和系统升级。

**分层处理的坏处**

一层层实现，效率相对来说较低

**但总体来说，好处比坏处多得多**

----

**Internet协议栈（应用层最高，物理层最低）**

应用层（可以进行应用报文交互）

传输层（传输层借助网络层主机到主机的服务，实现进程到进程的区分，借助socket和端口等。TCP可将不可靠变为可靠）

网络层（源主机到目标主机的端到端的传输，可能不可靠）

链路层（传输以帧为单位的数据，区分哪些比特是帧的开始，哪些比特是帧的结束，中间夹着的就是帧的数据，在相邻两点间传输帧）

物理层（把一个个bit中数字信号转化为媒体信号，承载在媒体上，然后从一点传到另一点，然后再将物理信号反转成数字信号）

**ISO的OSI七层模型**

表示层：表示转换，解释传输的数据，关心语义方面的信息，不管怎么样编码。

会话层：数据交换的同步、检查、恢复。

**封装和解封装**

源主机大封装（按层从上到下封装），目的主机大解封装（按层从下到上解封装）。

路由器解封装三层（到网络层）。交换机解封装两层（到链路层）。

# 计算机网络的发展历史

**早期1960前**：线路交换（不适合。**1.**线路建立时间长代价大，**2.**线路交换资源独享，不适合突发性很强的计算机通信，**3.**可靠性不高，核心节点一旦损毁，影响很大）

**分组交换的研究1962-1972**：三个研究小组分别展开。突发性强的情况下，比较适合计算机之间的通信。

1969年，第一个ARPAnet节点开始工作，给军方使用。这个节点叫做IMP接口报文处理机。1969年底（4个节点）。

1972年，第一个email程序发布，ARPAnet有了15个节点。

**专用网络和网络互联1972-1980**

很多专用网络出现。但是标准多，混乱。IBM内部的标准就有40多种。更不要说各种不同的公司要互联互通

**用覆盖的方式，解决网络互连**

如果弃用原来的所有设备，另起炉灶虽然好，可以解决互连，但成本大。

采用覆盖的方式，解决互连：ip层之下，各个网络各管各的（每种类型的物理网络分配一个ip头），在ip层上统一成ip网络，路由器将ip数据报取出，然后转发，打入另一个物理网络。**原来的网络可以完美利用**

网络IP提供的服务是最小限度的，尽力而为的服务。在端系统，通过TCP协议保证可靠。路由器不维护通信状态。 

> 投资保护性很强，包容性很强。只需要改变一下软件，网络就可以接入互联网。

**NCP协议变化为TCP/IP（一层变两层）**

1983，ALOHA net所有设备停机，进行软件升级，升级到新的协议栈。层次的变化，将主机设备和路由设备区分开来了。对当时来说也是一个

**IP协议的包容性**：在IP层上可以统一部署各种应用。IP可以将底层的所有物理架构包容起来。

**1982 SMTP协议**可实现email，**1983 DNS协议被定义**实现域名解析，**1985实现了FTP**，**1988 TCP**加入了拥塞控制

1990左右，ARPAnet是美国军方支持的，NSF net是ARPAnet的访问网。

**1994 Netscape公司成立**弄出了Netscape浏览器。

**出现了**即时通信、P2P文件共享，等杀手级应用。促进了ISP扩容。但安全性问题以及地址不够的问题不断突出。

**2001网络泡沫**一些烂公司倒闭了，好公司（包括微软雅虎谷歌思科等）得以沉淀。

……
